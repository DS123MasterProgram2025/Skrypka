---
title: "Лабораторна робота № 5. Аналіз часових рядів на основі ARIMA"
author: ''
date: ""
output:
  html_notebook:
    toc: true
    toc_float: true
    number_sections: true
  html_document:
    toc: true
    df_print: paged
editor_options:
  chunk_output_type: inline
encoding: "UTF-8"
---
**Мета:** *Навчитись аналізувати часові ряди та будувати ARIMA-моделі та прогнози на їх основі засобами мови програмування R.*

## 1. Підготовка даних

Дослідимо динаміку щорічної кількості випадків чоловічого безпліддя. Джерелом даних є офіційна медична статистика по регіонах України за період 1993–2017 рр.

```{r setup, message=FALSE, warning=FALSE}
# Підключення бібліотек
library(tidyverse)
library(forecast) # Основна бібліотека для ARIMA
library(tseries)  # Для тестів на стаціонарність
library(knitr)
library(readxl)

raw_data <- read_excel("data/infertility.xlsx")

ua_data <- raw_data %>%
  select(-Область, -Стать) %>%
  summarise(across(everything(), \(x) sum(x, na.rm = TRUE))) %>%
  pivot_longer(cols = everything(), names_to = "Year_Raw", values_to = "Cases") %>%
  mutate(Year = as.numeric(gsub("X", "", Year_Raw))) %>% 
  arrange(Year) %>%
  select(Year, Cases)

ts_male <- ts(ua_data$Cases, start = min(ua_data$Year), frequency = 1)

kable(head(ua_data), caption = "Фрагмент агрегованих даних по Україні")
```

## Попередній аналіз та візуалізація

Побудуємо графік часового ряду для візуальної оцінки тренду.

```{r}
autoplot(ts_male) +
  geom_point(color = "steelblue") +
  geom_smooth(method = "loess", se = FALSE, color = "darkred", linetype = "dashed") +
  labs(
    title = "Динаміка випадків чоловічого безпліддя в Україні (1993-2017)",
    y = "Кількість випадків",
    x = "Рік"
  ) +
  theme_minimal()
```

Аналіз динаміки та гіпотези

Спостерігаючи графік, можна виділити кілька етапів:

*    **1993–2000 рр.**: Відносна стабільність або повільне зростання.

*    **2000–2010 рр.**: Різке зростання показників (пік припадає на 2008-2010 роки).

    Після 2013 р.: Різкий спад (ймовірно, пов'язаний з втратою статистики з тимчасово окупованих територій АР Крим та частини Донбасу, а також загальною демографічною кризою).

Гіпотези щодо причин такої динаміки:

*    **Соціально-економічні чинники**: Стресові фактори 90-х та кризи 2008 року могли мати відкладений вплив на репродуктивне здоров'я.

*    **Екологія та спосіб життя**: Зростання урбанізації, гіподинамія, шкідливі звички.

*    **Діагностика**: Сплеск у 2000-х може пояснюватися не стільки реальним погіршенням здоров'я, скільки впровадженням нових протоколів обстеження чоловіків та появою приватних репродуктивних клінік.

*    **Статистичний артефакт**: Спад після 2014 року майже напевно корелює з виключенням даних з окупованих територій.

## Перевірка на стаціонарність

Для коректної роботи ARIMA ряд має бути стаціонарним (незмінні в часі середнє та дисперсія). Використаємо розширений тест Дікі-Фуллера (ADF).

```{r}
# Тест на стаціонарність вихідного ряду
adf_res <- adf.test(ts_male)
print(adf_res)
```

Якщо `p-value` > 0.05, ряд є нестаціонарним.

### Стабілізація ряду

Якщо ряд нестаціонарний, застосуємо диференціювання (різниця між сусідніми значеннями).

```{r}
# Визначення необхідного порядку диференціювання (d)
d_optimal <- ndiffs(ts_male)
cat("Рекомендована кількість диференціювань (d):", d_optimal, "\n")

# Побудова графіків автокореляції (ACF) та часткової автокореляції (PACF)
ts_diff <- diff(ts_male, differences = d_optimal)
ggtsdisplay(ts_diff, main = paste("Продиференційований ряд (d =", d_optimal, ")"))
```

Після диференціювання ряд виглядає більш схожим на білий шум (коливається навколо нуля).

## Побудова ARIMA-моделі

Використаємо алгоритм `auto.arima`, який автоматично перебирає комбінації параметрів `(p,d,q)` та обирає найкращу за інформаційним критерієм Акаіке (`AIC`).

```{r}
# Побудова моделі
best_model <- auto.arima(ts_male, seasonal = FALSE, stepwise = FALSE, approximation = FALSE)

# Вивід результатів
summary(best_model)
```

Отримано модель ARIMA(`r best_model$arma[1]`, `r best_model$arma[6]`, `r best_model$arma[2]`). Це означає:

*    **p (авторегресія)**: `r best_model$arma[1]`

*    **d (порядок інтеграції)**: `r best_model$arma[6]`

*    **q (ковзне середнє)**: `r best_model$arma[2]`

### Перевірка залишків (Residuals Check)

Важливий етап — перевірити, чи не залишилось у похибках моделі якоїсь інформації. Залишки мають бути нормально розподілені і не корельовані.

```{r}
checkresiduals(best_model)
```

Якщо `p-value` тесту Люнга-Бокса > 0.05, то залишки випадкові, і модель є адекватною.

## Прогнозування

Виконаємо прогноз на 3 роки вперед.

```{r}

# Прогноз
forecast_horizon <- 3
my_forecast <- forecast(best_model, h = forecast_horizon)

# Вивід значень прогнозу
knitr::kable(as.data.frame(my_forecast), caption = "Прогнозні значення", digits = 2)

# Візуалізація
autoplot(my_forecast) +
  labs(
    title = "Прогноз випадків чоловічого безпліддя",
    y = "Кількість випадків",
    x = "Рік"
  ) +
  theme_light() +
  theme(plot.title = element_text(face = "bold", hjust = 0.5))

```

## Висновки

*    **Проаналізовано** динаміку чоловічого безпліддя в Україні за 1993–2017 роки. Виявлено значну волатильність даних, зокрема зростання до 2010 року та спад після 2013 року, що пов'язано як з медичними, так і з геополітичними факторами.

*    **Побудовано** модель ARIMA, яка пройшла перевірку на адекватність (тест залишків).

*    **Отриманий** прогноз вказує на [додай сюди опис: стабілізацію / подальше падіння / зростання] показника у найближчі роки, проте слід враховувати широкі довірчі інтервали (сіра зона на графіку), що свідчить про високу невизначеність прогнозу в умовах нестабільної статистики.